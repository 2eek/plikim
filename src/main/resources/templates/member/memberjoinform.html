<!DOCTYPE>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" >
<head th:replace="fragments/common :: head('plikim')">
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" th:replace="fragments/common :: menu('home')">
    </nav>

<style>
	body {
    background-image: url('/img/space4.jpeg');
    /*background-color: #777777;*/
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    height: 100vh; /* 추가된 부분 */
}
<!--
아이디 중복체크-->.id_ok {
	color: #008000;
	display: none;
}

.id_already {
	color: #6A82FB;
	display: none;
}

.h5 {
	color: red;
}

h8 {
	color: red;
}

.btn-default{
    border: 1px solid #ccc;
    padding: 5px 10px;
}
</style>


<!--	<script src="https://kit.fontawesome.com/d58c3728d1.js"-->
<!--		crossorigin="anonymous"></script>-->

	<div class="wrap" >
		<div
			class="position-relative overflow-hidden radial-gradient min-vh-100 d-flex align-items-center justify-content-center">
			<div class="d-flex align-items-center justify-content-center w-100">
				<div class="row justify-content-center w-100">
					<div class="col-md-8 col-lg-6 col-xxl-8">
						<div class="card mb-0">
							<div class="card-body" >
								<a href="index.html"
									class="text-nowrap logo-img text-center d-block py-3 w-100">
								</a>

								<div>
									<h3 class="text-center">회원가입</h3>
								</div>
								<form  id="insertForm" action="/user/save" method="post">
									<h8>*는 필수입력 사항입니다.</h8>

									<div class="mb-3">
										<label class="form-label"
											style="float: left; display: inline;"><span class=h5>*</span>아이디</label>

										<input type="text" name="userId" placeholder="아이디"
											class="form-control" id="id" aria-describedby="textHelp"
											required>
									</div>
									<div>
										<font id="spaceId" size="2"></font>
									</div>
									<div class="mb-3">
										<div class="main">
											<label class="form-label"><span class=h5>*</span>비밀번호</label>
											<i class="fa-solid fa-eye-slash fa-xs" id="togglePassword1"></i> <input
												type="password" name="password" placeholder="비밀번호"
												class="form-control" id="pw1" required> <font
												id="pw" size="2"></font>
										</div>
									</div>

									<div class="mb-3">
										<div class="main">
											<label  class="form-label"><span class=h5>*</span>비밀번호
												확인</label> <i class="fa-solid fa-eye-slash fa-xs" id="togglePassword2"></i> <input
												type="password" name="" placeholder="비밀번호 확인"
												class="form-control" id="pw2" required>
										</div>
									</div>
									<font id="checkPw" size="2"></font> <br>

<!--									<label><span class=h5>*</span>국적</label>적-->

<!--									<div class="mb-3"> -->
<!--										<select class="" id="nationality" name="nationality"-->
<!--											aria-label="Default select example" required>-->
<!--											<option value="">국가선택</option>-->
<!--											<option value="대한민국">대한민국</option>-->
<!--											<option value="일본">일본</option>-->
<!--											<option value="중국">중국</option>-->
<!--											<option value="미국">미국</option>-->
<!--											<option value="캐나다">캐나다</option>-->
<!--											<option value="필리핀">필리핀</option>-->

<!--										</select> <br /> <br />-->

<!--									</div>-->



									<div class="mb-3">
										<label  class="form-label"><span class=h5>*</span>이메일</label>
										<input type="email" name="email" placeholder="이메일"
											class="form-control" id="email" required>
										<font id="spaceEmail" size="2"></font>
									</div>

									<div class="mb-3">
										<label class="form-label"><span class=h5>*</span>이름</label>
										<input type="text" name="userName" placeholder="이름"
											class="form-control" id="name" required>
									</div>




									<div class="mb-3">
										<label  class="form-label"><span class=h5>*</span>전화번호
											&nbsp; </label>

										<input type="text" class="form-control" name="phoneNumber"
											id="phonenumber" placeholder="전화번호를 입력하세요" style="width: 50%; " required>
												<div>
										<font id="spacePhonenum" size="2"></font>
									</div>
											<button type="button" id="sendCode" class="btn btn-default" style="">코드 발송</button>
									</div>

									<div id="codeCheck" class="mb-3" style="display: none">
										<input type="text" class="form-control" name="smsCode"
											id="smsCode" placeholder="코드 입력하세요" required>
										<button type="button" id="code" name="codeConfirmBtn"
											class="btn btn-default"  onclick="confirmSmsCode()" value="">코드
											확인</button>
<!--										onclick="confirmCode()"-->
									</div>
									<br> <input type="hidden" id="numValue" value="">

									<div class="mb-3">
										<label  class="form-label">생년월일</label> <input
											type="date" name="birthday" placeholder="생일"
											class="form-control" id="birthday" required>
									</div>

									<div>
										<label  class="form-label"><span class=h5>*</span>성별</label> <br /> <input
											type="radio" id="male" name="gender" value="G1" checked="checked">남 <input
											type="radio" id="female" name="gender" value="G2">여
									</div>
									<br> <button id="submitButton" type="button" class="btn btn-primary w-100 py-8 fs-4 mb-4 rounded-2">회원가입</button>

<!--									type="submit"-->
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!--  sms코드 전송 -->
<script th:inline="javascript">
	//회원가입 버튼 누르면 메서드 실행 후 회원가입처리
	document.getElementById("submitButton").addEventListener("click", function(event) {
		console.log('?????')
		joinform_check(event)

	});


//아이디 중복체크

$('#id').on('blur', checkUserIdAvailability);
$('#id').on('input', checkUserIdAvailability);
// $('#id').on('blur', checkUserIdAvailability);
		function checkUserIdAvailability() {
				var id = $("#id").val();

				// if (id.length < 5 || id.search(/\s/) !== -1 || !/^[a-zA-Z0-9]*$/.test(id)) {
				// 	$("#spaceId").html("아이디는 최소 5글자 이상이어야 하며, 영문 대소문자와 숫자로만 입력해주세요.");
				// 	$("#spaceId").attr('color', 'red');
				//
				//
				//
				// }
				$.ajax({
					url: "/idCheck",
					type: "post",
					data: {userId: id},
					dataType: 'json',
					success: function (result) {
						if (result === 0) {
							$("#spaceId").html('사용할 수 있는 아이디입니다.');
							$("#spaceId").attr('color', 'green');


						} else if (result === 1) {
							$("#spaceId").html('사용할 수 없는 아이디입니다.');
							$("#spaceId").attr('color', 'red');
							$("#id").focus();


						} else if (result === 2) {
							//유효성 검사
							$("#spaceId").html("아이디는 최소 5글자 이상, 영문 대소문자와 숫자로만 입력해주세요.");
							$("#spaceId").attr('color', 'red');
							$("#id").focus();
									console.log('AAAAAAA')


						}
					},
					error: function () {
						alert("서버요청실패");
					}
				});

			}


//HTML 문서의 모든 요소들이 브라우저에 로드되고 초기화된 후에 스크립트 코드를 실행하고자 할 때 사용됨. 돔형성 후
		 $(document).ready(function () {
// 코드발송

        $('#sendCode').on('click', function() {
			console.log('hi')
            let receiverId = document.getElementById("phonenumber").value;

            if (receiverId === "") {
                alert("휴대폰 번호를 입력하세요.");
                $("#Number").focus();
                return false;
            }
			//문자 발송
             sendSMS();
			//코드 입력폼 활성화
           	 sendCodeForm();

			//휴대폰 중복체크

        });

		//문자 발송 ajax
        function sendSMS() {
            let phoneNumber = document.getElementById("phonenumber").value;

            $.ajax({
                url: "/sms/send",
                type: 'post',
                data: {to : phoneNumber },
            })
            .done(data => {
                console.log("통신은 성공");

                if (data != null && data.num != null) {
                    alert(`${phoneNumber} 문자발송했습니다`);
                    $("#numValue").val(data.num);
                } else {
                    alert(`문자 발송 안됐습니다.`);
                }
            })
            .fail(reject => console.log(reject));
        }
		//코드입력창, 검증 버튼 화면에 보이게 하기
        function sendCodeForm() {
            $("#codeCheck").css("display", "block");
        }
    });

	//코드 확인 버튼, ajax 뒷단에서 전송한 값과 입력한 값 맞는지 확인 처리
	// $('#code').on('click', function () {



	function confirmSmsCode(){

			var phoneNumberValue = $("#phonenumber").val();
			var userCodeValue = $("#smsCode").val();
			$.ajax({
				url: "/compareCodes",
				type: 'post',
						//보내는 키(서버에서 받는 키), 밸류(변수 정의 필요함)
				data: { inputedPhonenumber:phoneNumberValue, userInputNumber: userCodeValue, },
			})
					.done(success => {
						console.log("서버로 회원의 입력값 보내기 성공");

						if (success.result === "success") {
							alert("입력 값이 일치합니다. ")
							//코드 일치하면db에 휴대폰 정보 있는지 확인 필요.

							console.log('코드 인증 성공');
							checkPhoneNumber()
						} else {
							alert("입력 값이 일치하지않습니다. ")
						}
					})
					.fail(() => {
						console.error("서버요청 실패");
						alert("서버요청 실패");
					});
			//전화번호 중복 체크
			// checkPhoneNumber()
	};


//이메일 중복체크
// 	$("#email").on('input', function () {
// 		    var email = $("#email").val();
//
//     //이메일 형식 검사 (스페이스나 '@' 없는 이메일은 무시)
//     if (!isValidEmailFormat(email)) {
// 		       $("#spaceEmail").html('이메일을 다시 확인해주세요.');
// 					$("#spaceEmail").attr('color', 'red');
// 		   // checkEmail();
//     }
//
// });

$("#email").on('blur', function () {
		checkEmail();
	});


	function checkEmail() {
		  var email = $("#email").val();


    $.ajax({
        url: "/emailCheck",
        type: "post",
        data: {email: email},
        dataType: 'json',
        success: function (result) {
            if (result==-1)  {
				$("#spaceEmail").html('이메일 형식이 아닙니다.');
				$("#spaceEmail").attr('color', 'red');
				 $("#email").focus();

            } else if( result ==0){
				$("#spaceEmail").html('사용 가능한 이메일입니다.');
				$("#spaceEmail").attr('color', 'green');



            }else{
				$("#spaceEmail").html('사용 불가 이메일입니다.');
				$("#spaceEmail").attr('color', 'red');
				$("#email").focus();


			}
        },
        error: function () {
            alert("서버요청실패");
        }
    });
}



function isValidEmailFormat(email) {
    // 이메일 형식 검사 (스페이스나 '@' 없는 이메일은 무시)
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}




// confirmSmsCode()

//휴대폰 번호 중복 체크
			function checkPhoneNumber() {


				var phonenumber = $("#phonenumber").val();
				var reg = /^[0-9]+/g;

				if (!reg.test(phonenumber)) {
					alert("전화번호는 숫자만 입력할 수 있습니다.");
					phonenumber.focus();
					return false;
				}

				if (phonenumber === '') {
					$("#spacePhonenum").html("");

				}


				// Ajax로 휴대폰 번호 중복 체크
				$.ajax({
					url: "/phoneNumberCheck",
					type: "post",
					data: {phoneNumber: phonenumber},
					dataType: 'json',
					success: function (result) {
						 if ($.isEmptyObject(result) || result.userId === null) {
							console.log('전화번호 사용 가능:', phonenumber);
							// 코드 발송 등 필요한 로직 수행
							$("#spacePhonenum").html('사용할 수 있는 전화번호입니다');
							$("#spacePhonenum").css('color', 'green');


						} else {
				console.log('전화번호 중복 확인 결과:', result);
								console.log('빈객체!!'+result)
							alert("이미 등록된 전화번호입니다.");
							// $("#spacePhonenum").html('이미 등록된 전화번호입니다.');

						   	document.getElementById("phonenumber").value = '';
							 $("#codeCheck").css("display", "none");
							document.getElementById("smsCode").value = '';
							$("#spacePhonenum").html('다시 입력해주세요.');
						    $("#spacePhonenum").css('color', 'red');


							// 중복된 전화번호인 경우 코드 발송 로직을 실행하지 않도록 설정

						}
					},
				error: function (xhr, status, error) {
    console.error("서버 요청 실패:", status, error);
    alert("서버 요청 실패: " + status + " - " + error);
}
				});
			}



//비밀번호 체크
			$('#pw1').on('input', function () {
				var pw = $("#pw1").val();
				var num = pw.search(/[0-9]/g);
				var eng = pw.search(/[a-z]/ig);
				var spe = pw.search(/[`~!@@#$%^&*|₩₩₩'₩";:₩/?]/gi);

				if (pw.length < 8 || pw.length > 20) {
					$("#pw").html("8자리 ~ 20자리 이내로 입력해주세요.");
					$("#pw").attr('color', 'red');

				} else if (pw.search(/\s/) != -1) {
					$("#pw").html("비밀번호는 공백 없이 입력해주세요.");
					$("#pw").attr('color', 'red');

				} else if (num < 0 || eng < 0 || spe < 0) {
					$("#pw").html("영문,숫자, 특수문자를 혼합하여 입력해주세요.");
					$("#pw").attr('color', 'red');

				} else {
					$("#pw").html("조건을 충족합니다.");
					$("#pw").attr('color', 'green');
					$("#pw2").focus();
				}
			});

			$('#pw2').on('input', function () {
				var number1 = $("#pw1").val();
				var number2 = $("#pw2").val();

				if (number1 == number2) {
					$("#checkPw").html('번호가 같습니다.');
					$("#checkPw").attr('color', 'green');
						$("#email").focus();

				} else {
					$("#checkPw").html('번호가 다릅니다.');
					$("#checkPw").attr('color', 'red');
						return false;

				}
			});

			//비밀번호 체크 eye
			$(document).ready(function () {
				$('#togglePassword1, #togglePassword2').on('click', function () {
					var inputField = $(this).siblings('input');
					inputField.toggleClass('active');

					if (inputField.hasClass('active')) {
						$(this).attr('class', 'fa-solid fa-eye-slash fa-xs');
						inputField.attr('type', 'text');
					} else {
						$(this).attr('class', 'fa-solid fa-eye fa-xs');
						inputField.attr('type', 'password');
					}
				});
			});


			<!-- Join form validation -->

//회원가입시 유효성 체크

				//이메일 체크 ajax
				// checkEmail()
				// Swal.fire({
				// 	title: '정말로 그렇게 하시겠습니까?',
				// 	text: '다시 되돌릴 수 없습니다. 신중하세요.',
				// 	icon: 'warning',
				//
				// 	showCancelButton: true, // cancel버튼 보이기. 기본은 원래 없음
				// 	confirmButtonColor: '#3085d6', // confrim 버튼 색깔 지정
				// 	cancelButtonColor: '#d33', // cancel 버튼 색깔 지정
				// 	confirmButtonText: '승인', // confirm 버튼 텍스트 지정
				// 	cancelButtonText: '취소', // cancel 버튼 텍스트 지정
				//
				// 	reverseButtons: true, // 버튼 순서 거꾸로
				//
				// }).then(result => {
				// 	// 만약 Promise리턴을 받으면,
				// 	if (result.isConfirmed) { // 만약 모달창에서 confirm 버튼을 눌렀다면
				//
				// 		Swal.fire('승인이 완료되었습니다.', '화끈하시네요~!', 'success');
				// 	}
				// });

//회원가입시 유효성 체크
function joinform_check(event) {
				// checkUserIdAvailability1()
				console.log('test 버튼')
	// 				checkUserIdAvailability()
	// return false;
    var uid = document.getElementById("id");
    var pwd = document.getElementById("pw1");
    var repwd = document.getElementById("pw2");
    var uname = document.getElementById("name");
    var female = document.getElementById("female");
    var male = document.getElementById("male");
    var mobile = document.getElementById("phonenumber");
    var email = document.getElementById("email");
    var smsCode = document.getElementById("smsCode");



//
//     // 아이디 유효성 검사
    if (uid.value == "" || uid.value.trim() === "" || uid.value.search(/\s/) !== -1 || !/^[a-zA-Z0-9]*$/.test(uid.value) || uid.value.length < 5) {
	$("#spaceId").html("아이디는 최소 5글자 이상이어야 하며, 영문 대소문자와 숫자로만 입력해주세요.");
	$("#spaceId").attr('color', 'red');
    $("#id").focus();
		return  false;
}

		 // checkUserIdAvailability()



    // pw 유효성 검사
    if (pwd.value == "") {
		alert("비밀번호를 입력하세요.");
        // $("#pw1").focus();

        return false;
    }

    var number1 = $("#pw1").val();
    var number2 = $("#pw2").val();

    // 비밀번호 확인
    if (repwd.value == "" || number1 !== number2) {
        // alert("비밀번호 확인하세요.");
        // $("#pw2").focus();

        return false;
    }

    if (email.value == "") {
        // alert("이메일을 입력하세요!!!");
        $("#email").focus()
	return false;
	}




    if (uname.value.trim() === "") {
        // alert("이름을 입력하세요.");
        $("#name").focus();

        return false;
    }

    if (mobile.value == "") {
        alert("전화번호 입력하세요.");
        $("#phonenumber").focus();

        return false;
    }

    if (smsCode.value == "") {
        alert("코드 인증 하세요.");

        return false;
    }

    var female = document.getElementById("female");
    var male = document.getElementById("male");

    // 성별을 선택하지 않았을 때
    // if (!female.checked && !male.checked) {
    //     alert("성별을 선택하세요.");
	//
    //      return false;
    // }
	// checkPhoneNumber()
	// return false;

    // var smsCode = document.getElementById("smsCode");
    // if (smsCode.value === "") {
    //     alert("휴대폰 인증 코드를 입력하세요.");
	//
    //     return false;
    // }
	//
    // var number1 = $("#pw1").val();
    // var number2 = $("#pw2").val();
	//
    // if (number1 !== number2) {
    //     alert('비밀번호가 일치하지 않습니다.');
	//
    //     return false;
    // } else {
    //     var pwValidationResult = validatePassword(number1);
	//
    //     if (!pwValidationResult) {
    //         alert('비밀번호 조건을 다시 확인해주세요.');
	//
	//
    //     }
    // }

	    function validatePassword(pw) {
        var num = pw.search(/[0-9]/g);
        var eng = pw.search(/[a-z]/ig);
        var spe = pw.search(/[`~!@@#$%^&*|₩₩₩'₩";:₩/?]/gi);

        if (pw.length < 8 || pw.length > 20) {
            $("#pw").html("8자리 ~ 20자리 이내로 입력해주세요.");
            $("#pw").attr('color', 'red');
			$("#pw1").focus();
            return false;
        } else if (pw.search(/\s/) != -1) {
            $("#pw").html("비밀번호는 공백 없이 입력해주세요.");
            $("#pw").attr('color', 'red');
				$("#pw1").focus();
            return false;
        } else if (num < 0 || eng < 0 || spe < 0) {
            $("#pw").html("영문, 숫자, 특수문자를 혼합하여 입력해주세요.");
            $("#pw").attr('color', 'red');
				$("#pw1").focus();
            return false;
        } else {
            $("#pw").html("조건을 충족합니다.");
            $("#pw").attr('color', 'green');
				$("#pw2").focus();

        }
    }

	//휴대폰 번호 중복 막기
checkPhoneNumber()

checkUserIdAvailability1(event)
function checkUserIdAvailability1(event) {
				var id = $("#id").val();

				// if (id.length < 5 || id.search(/\s/) !== -1 || !/^[a-zA-Z0-9]*$/.test(id)) {
				// 	$("#spaceId").html("아이디는 최소 5글자 이상이어야 하며, 영문 대소문자와 숫자로만 입력해주세요.");
				// 	$("#spaceId").attr('color', 'red');
				//
				//
				//
				// }
				$.ajax({
					url: "/idCheck",
					type: "post",
					data: {userId: id},
					dataType: 'json',
					success: function (result) {
						if (result === 0) {
							$("#spaceId").html('사용할 수 있는 아이디입니다.');
							$("#spaceId").attr('color', 'green');
enableSubmitButton()
						} else if (result === 1) {
							$("#spaceId").html('사용할 수 없는 아이디입니다.');
							$("#spaceId").attr('color', 'red');
							$("#id").focus();
							alert('아이디 못쓴다@@@@@@@')

	return false;

						} else if (result === 2) {
							//유효성 검사
							$("#spaceId").html("아이디는 최소 5글자 이상, 영문 대소문자와 숫자로만 입력해주세요.");
							$("#spaceId").attr('color', 'red');
							$("#id").focus();
								alert('BBBBB ')
								alert('아이디 5글자 이상! ')
	event.preventDefault(event);
	return false;
						}
					},
					error: function () {
						alert("서버요청실패");
					}
				});

			}
	console.log('여기까지 오나')
	// event.preventDefault(event);

    // 모든 조건이 만족하면 enableSubmitButton 호출

// enableSubmitButton()
	function enableSubmitButton() {
    document.getElementById("insertForm").submit();
}

}

// function disableSubmitButton() {
//     // 서브밋 막음
//     $("#submitButton").prop("disabled", true);
// }
//
// function enableSubmitButton() {
//     // 서브밋 안막음
//     // $("#submitButton").prop("disabled", false);
// 	    document.getElementById("submitButton").type = "submit";
// }
//


//
// const $form = document.querySelecotr('form');
//
// $form.addEventListener("submit", (event) => {
//   // 동작(이벤트)을 실행하지 못하게 막는 메서드입니다.
//   event.preventDefault();
//
//   console.log(event.target);
// });
</script>


</body>
</html>