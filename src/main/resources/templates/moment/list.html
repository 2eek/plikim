<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<style>
    .user-table th, .user-table td {
        font-size: 12px;
    }

    /* 추가된 스타일 */
    .form-container {

        margin-bottom: 10px;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;

    }


    .form-container-inputform {
        margin-top: 10px;
        margin-bottom: 20px;
        padding: 20px;
        border: 4px solid #8474c7;
        border-radius: 8px;
        position: fixed;
        top: 60px;
        left: 0;
        width: 100%;
        background-color: white;
        z-index: 1000;
        padding: 20px;
        /*border-bottom: 1px solid darkgray;*/
    }


    .input-area {
        width: 100%;
        height: 100px;
        margin-bottom: 10px;
    }

    .image-upload {
        margin-bottom: 10px;
    }

    .button-container {
        text-align: right;
    }

    .button-container button {
        margin-left: 10px;
    }

    .selected-images {
        display: flex;
    }

    .selected-images img {
        max-width: 100px;
        max-height: 100px;
        margin-right: 10px;
    }

    .moment {
        position: relative;
        top: 400px;
    }

    .fixed-container {
        border-radius: 8px;
        width: 100%;
        height: 300px;
        position: fixed;
        top: 0;
        left: 0;
        background-color: #ffffff; /* 배경색을 원하는 색상으로 지정합니다. */
        z-index: 999;
    }

</style>

<head th:replace="fragments/common :: head('moment')">
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top" th:replace="fragments/common :: menu('moment')">
</nav>
<div class="form-container-inputform">
    <a class="btn"
       style="background-color: transparent; border: none; padding: 0;">

        <img th:src="@{${#strings.isEmpty(commonUser.storedFileName) ? '/uploads/basicProfile.jpg' : '/uploads/' + commonUser.storedFileName}}"
             alt="Profile Image"
             style="width: 35px; height: 35px; object-fit: cover; margin-bottom:10px; border-radius: 50%; overflow: hidden;"
             sec:authorize="isAuthenticated()">

    </a>
    <textarea class="input-area form-control"
              placeholder="입력하세요" id="area-content" name="content" maxlength="200"></textarea>
    <div class="invalid-feedback" id="error-message">
        내용 에러 메세지
    </div>
    <!-- 파일 선택 input -->
    <!--    <input type="file" class="image-upload" accept="image/*" multiple onchange="previewImages(this)">-->

    <div class="button-container">
        <input id="upload_file" type="file" class="image-upload" accept="image/*" multiple onchange="onChange(event)"
               style="position:absolute; clip:rect(0, 0, 0, 0);">
        <label for="upload_file"
               style="border: 1px solid darkgray; padding: 5px; margin-bottom:0px; cursor: pointer; display: inline-block; background-color: #f0f0f0; border-radius: 5px; float: left">
            첨부 이미지
        </label>
        <button class="btn btn-primary" onclick="submitForm()">입력</button>
        <button class="btn btn-primary" onclick="updateForm()">수정</button>
        <button class="btn btn-primary" onclick="deleteForm()">삭제</button>
    </div>

    <!-- 이미지 미리보기 영역 -->
    <div id="image-preview-container" class="selected-images" style="margin-top:10px"></div>


</div>

<div class="fixed-container "></div>
<div id="content"> <!-- 이 부분이 있는지 확인하세요. -->
    <!-- content 내용 -->
</div>
<!--여기-->
<!--데이터 반환 폼-->
<div class="moment" th:each="moment : ${moments}" style="overflow: auto;">
    <div class="form-container" style="border: 2px solid blue;">
        <div>
            <a class="btn" style="background-color: transparent; border: none; padding: 0;">
                <img th:src="@{${#strings.isEmpty(commonUser.storedFileName) ? '/uploads/basicProfile.jpg' : '/uploads/' + commonUser.storedFileName}}"
                     alt="Profile Image"
                     style="width: 35px; height: 35px; object-fit: cover; margin-bottom:10px; border-radius: 50%; overflow: hidden;"
                     sec:authorize="isAuthenticated()">
            </a>
        </div>
        <div style="overflow: auto;">
            <textarea class="input-area form-control"
                      th:text="${moment.content}" name="content" maxlength="200" readonly></textarea>
            <div th:each="momentImg : ${moment.momentImg}">
                <img th:src="@{'/uploads/moment/' + ${momentImg.storedFileName}}" alt="Moment Image"
                     style="width: 100px; height: 100px; margin-right: 10px; float: left;">
            </div>

        </div>

    </div>
    <!-- 추가된 clearfix -->
    <div style="clear: both;"></div>
</div>


<script th:inline="javascript">
    let selectedImages = [];

    function onChange(event) {
        previewImages(event.target.files);
        event.target.value = '';
    }

    function previewImages(files) {
        const previewContainer = document.getElementById('image-preview-container');

        // 최대 3개까지만 미리보기 표시
        for (let i = 0; i < Math.min(files.length, 3); i++) {
            const file = files[i];

            // 이미지가 3개를 넘어가면 alert 창 띄우고 추가 중단
            if (selectedImages.length >= 3) {
                alert('최대 3개까지만 선택할 수 있습니다.');
                break;
            }

            // 선택된 이미지 배열에 추가
            selectedImages.push(file);

            // 미리보기 이미지 엘리먼트 생성 및 추가
            const previewImg = createPreviewImage(file);
            previewContainer.appendChild(previewImg);
        }
    }

    function createPreviewImage(file) {
        const previewImg = document.createElement('img');
        previewImg.src = URL.createObjectURL(file);
        previewImg.alt = 'Image Preview';
        previewImg.style.width = '100px';  // 이미지 너비를 100px로 설정
        previewImg.style.height = '100px'; // 이미지 높이를 100px로 설정

        // 손가락 표시 및 이미지 이름 뜨게 설정
        previewImg.style.cursor = 'pointer';
        previewImg.title = file.name;

        // 이미지 클릭 시 제거 이벤트 리스너 추가
        previewImg.addEventListener('click', () => removePreviewImage(previewImg, file));

        return previewImg;
    }

    function removePreviewImage(previewImg, file) {
        const index = selectedImages.indexOf(file);
        if (index !== -1) {
            selectedImages.splice(index, 1);  // 배열에서 해당 파일 제거
        }

        previewImg.remove();  // 뷰에서 해당 이미지 제거
    }

    <!--   전송  -->
    function submitForm() {
        // FormData 객체 생성
        var formData = new FormData();

        // Moment 객체의 content 필드와 동일한 이름으로 추가
        formData.append('content', $('#area-content').val());
        // 선택된 이미지를 FormData에 추가
        for (var i = 0; i < selectedImages.length; i++) {
            formData.append('momentImgs', selectedImages[i]);
        }

        $.ajax({
            type: 'POST',
            url: '/moment/save',
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                // 성공적으로 저장되면 실행되는 로직
                console.log('Save successful:', data);
fetchMomentList();
                // 새로운 Moment를 화면에 추가
                // appendMomentToScreen(data);

                // 추가적으로 필요한 로직 수행
            },
            error: function (error) {
                // 저장 중 오류가 발생하면 실행되는 로직
                console.error('Error saving data:', error.responseText);

// 받은 JSON 응답에서 에러 메시지 추출
var validationErrors = JSON.parse(error.responseText);

// 에러 메시지를 화면에 표시하는 등의 처리 로직 수행
// 예를 들어, 어떤 특정한 DOM 요소에 표시한다면:
$('#error-message').text(validationErrors.content);

// 내용 에러 메시지를 표시하는 부분
if (validationErrors.content) {
    // 내용 필드에 대한 처리
    $('#area-content').addClass('is-invalid');  // 빨간 테두리 클래스 추가
    $('#error-content').text(validationErrors.content);
} else {
    // 다른 필드에 대한 처리를 추가할 수 있음
    $('#area-content').removeClass('is-invalid');  // 에러가 없으면 클래스 제거
    $('#error-content').text('');  // 에러 메시지 초기화
}

            }
        });
                function fetchMomentList() {
            $.ajax({
                type: 'GET',
                url: '/moment/result',
                success: function (data) {
                    // 성공적으로 목록을 가져왔을 때, 화면에 갱신
                    updateMomentList(data);
                },
                error: function (error) {
                    console.error('Error fetching moment list:', error);
                }
            });
        }
function updateMomentList(moments) {
    const momentContainer = document.querySelector('.moment');
    momentContainer.innerHTML = ''; // 목록 초기화

        appendMomentToScreen(moments);

}


function appendMomentToScreen(momentData) {
    const momentContainer = document.querySelector('.moment');
    console.log('뭐있어' + momentContainer);

    // Create new div element for each moment
    const newMomentDiv = document.createElement('div');
    newMomentDiv.className = 'form-container';
    newMomentDiv.style.border = '2px solid blue';

    // Create an anchor element with a button for the profile image
    const profileImageAnchor = document.createElement('a');
    profileImageAnchor.className = 'btn';
    profileImageAnchor.style.backgroundColor = 'transparent';
    profileImageAnchor.style.border = 'none';
    profileImageAnchor.style.padding = '0';

    const profileImage = document.createElement('img');
    profileImage.src = '/uploads/basicProfile.jpg'; // Set a default image source
    profileImage.alt = 'Profile Image';
    profileImage.style.width = '35px';
    profileImage.style.height = '35px';
    profileImage.style.objectFit = 'cover';
    profileImage.style.marginBottom = '10px';
    profileImage.style.borderRadius = '50%';
    profileImage.style.overflow = 'hidden';

    profileImageAnchor.appendChild(profileImage);
    newMomentDiv.appendChild(profileImageAnchor);

    // Create a div for the text area
    const textAreaDiv = document.createElement('div');
    textAreaDiv.style.overflow = 'auto';

    const textArea = document.createElement('textarea');
    textArea.className = 'input-area form-control';
    textArea.textContent = momentData.content; // Set the content
    textArea.name = 'content';
    textArea.maxLength = '200';
    textArea.readOnly = true;

    // ... (Create other elements like images, etc., inside this div)

    textAreaDiv.appendChild(textArea);
    newMomentDiv.appendChild(textAreaDiv);

    // Append the new moment div to the container
    momentContainer.appendChild(newMomentDiv);

    // Create a div for clearfix and append it
    const clearfixDiv = document.createElement('div');
    clearfixDiv.style.clear = 'both';
    momentContainer.appendChild(clearfixDiv);
}

    }




</script>
</body>
</html>